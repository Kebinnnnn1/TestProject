{% extends 'accounts/base.html' %}

{% block title %}Admin Dashboard — AuthApp{% endblock %}

{% block content %}
<div class="container" style="padding: 3rem 1rem;">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-5 flex-wrap gap-3">
        <div>
            <h1 style="font-size: 1.9rem; font-weight: 700; color: #fff; margin-bottom: 0.3rem;">
                <i class="bi bi-speedometer2 me-2" style="color: #a5b4fc;"></i>Admin Dashboard
            </h1>
            <p style="color: #94a3b8; margin: 0;">Manage all registered users</p>
        </div>
        <div
            style="background: rgba(99,102,241,0.12); border: 1px solid rgba(99,102,241,0.3); border-radius: 12px; padding: 0.75rem 1.25rem;">
            <span style="color: #a5b4fc; font-weight: 600; font-size: 1.5rem;">{{ users|length }}</span>
            <span style="color: #64748b; font-size: 0.88rem; display: block; margin-top: -2px;">Total Users</span>
        </div>
    </div>

    <!-- Stats row -->
    <div class="row g-3 mb-5">
        <div class="col-sm-4">
            <div class="card-glass p-3 text-center">
                <p style="font-size: 1.6rem; font-weight: 700; color: #34d399; margin: 0;">
                    {{ users|length }}
                </p>
                <p style="color: #64748b; font-size: 0.82rem; margin: 0;">Registered</p>
            </div>
        </div>
        <div class="col-sm-4">
            <div class="card-glass p-3 text-center">
                <p style="font-size: 1.6rem; font-weight: 700; color: #a5b4fc; margin: 0;" id="activeCount">—</p>
                <p style="color: #64748b; font-size: 0.82rem; margin: 0;">Active</p>
            </div>
        </div>
        <div class="col-sm-4">
            <div class="card-glass p-3 text-center">
                <p style="font-size: 1.6rem; font-weight: 700; color: #fbbf24; margin: 0;" id="inactiveCount">—</p>
                <p style="color: #64748b; font-size: 0.82rem; margin: 0;">Inactive</p>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="table-dark-custom">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th>#</th>
                    <th>User</th>
                    <th>Email</th>
                    <th>Verified</th>
                    <th>Status</th>
                    <th>Role</th>
                    <th>Joined</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                {% for u in users %}
                <tr class="user-row" data-active="{{ u.is_active|lower }}">
                    <td style="color: #64748b; font-size: 0.85rem;">{{ forloop.counter }}</td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div
                                style="width: 34px; height: 34px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <span style="color: #fff; font-size: 0.78rem; font-weight: 700;">{{
                                    u.username|slice:":1"|upper }}</span>
                            </div>
                            <span style="font-weight: 500;">{{ u.username }}</span>
                            {% if u == request.user %}
                            <span style="font-size: 0.7rem; color: #a5b4fc;">(you)</span>
                            {% endif %}
                        </div>
                    </td>
                    <td style="color: #94a3b8;">{{ u.email }}</td>
                    <td>
                        {% if u.is_verified %}
                        <span class="badge-verified"><i class="bi bi-patch-check-fill me-1"></i>Yes</span>
                        {% else %}
                        <span class="badge-unverified"><i class="bi bi-x-circle me-1"></i>No</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if u.is_active %}
                        <span class="badge-active"><i class="bi bi-circle-fill me-1"
                                style="font-size: 0.5rem;"></i>Active</span>
                        {% else %}
                        <span class="badge-inactive"><i class="bi bi-circle-fill me-1"
                                style="font-size: 0.5rem;"></i>Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if u.is_superuser %}
                        <span class="badge-staff"><i class="bi bi-shield-fill-check me-1"></i>Superuser</span>
                        {% elif u.is_staff %}
                        <span class="badge-staff"><i class="bi bi-star-fill me-1"></i>Staff</span>
                        {% else %}
                        <span style="color: #64748b; font-size: 0.82rem;">User</span>
                        {% endif %}
                    </td>
                    <td style="color: #64748b; font-size: 0.85rem;">{{ u.date_joined|date:"M j, Y" }}</td>
                    <td>
                        {% if u != request.user %}
                        <form method="post" action="{% url 'toggle_user_active' u.pk %}" style="display: inline;">
                            {% csrf_token %}
                            {% if u.is_active %}
                            <button type="submit" class="btn-danger-custom btn">
                                <i class="bi bi-person-x me-1"></i>Deactivate
                            </button>
                            {% else %}
                            <button type="submit" class="btn-success-custom btn">
                                <i class="bi bi-person-check me-1"></i>Activate
                            </button>
                            {% endif %}
                        </form>
                        {% else %}
                        <span style="color: #475569; font-size: 0.82rem;">—</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center" style="color: #64748b; padding: 3rem;">
                        <i class="bi bi-people" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                        No users found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% block extra_scripts %}
<script>
    // Count active/inactive users and fill stats
    const rows = document.querySelectorAll('.user-row');
    let active = 0, inactive = 0;
    rows.forEach(r => {
        if (r.dataset.active === 'true') active++;
        else inactive++;
    });
    document.getElementById('activeCount').textContent = active;
    document.getElementById('inactiveCount').textContent = inactive;
</script>
{% endblock %}
{% endblock %}